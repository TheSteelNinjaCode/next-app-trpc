#!/usr/bin/env node
var __awaiter=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))((function(s,o){function a(t){try{c(i.next(t))}catch(t){o(t)}}function n(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,n)}c((i=i.apply(t,e||[])).next())}))};import{execSync}from"child_process";import fs from"fs";import{fileURLToPath}from"url";import path from"path";import chalk from"chalk";import prompts from"prompts";import{Project,SyntaxKind}from"ts-morph";const __filename=fileURLToPath(import.meta.url),__dirname=path.dirname(__filename);function modifyCustomAliasImports(t,e){return __awaiter(this,void 0,void 0,(function*(){const r=(new Project).addSourceFileAtPath(t),i=r.getImportDeclaration((t=>t.getNamedImports().some((t=>"AppRouter"===t.getName()||"appRouter"===t.getName()))));i&&i.setModuleSpecifier(e.src?`${e.importAlias}/server`:`${e.importAlias}/app/server`);const s=r.getImportDeclaration((t=>t.getNamedImports().some((t=>"createCallerFactory"===t.getName()))));s&&s.setModuleSpecifier(e.src?`${e.importAlias}/server/trpc`:`${e.importAlias}/app/server/trpc`),yield r.save()}))}function updateImportAliasFiles(t,e,r){return __awaiter(this,void 0,void 0,(function*(){const i=[path.join(t,`/${r}/app/_trpc/client.ts`),path.join(t,`/${r}/app/_trpc/serverClient.ts`),path.join(t,`/${r}/app/api/trpc/[trpc]/route.ts`)];yield Promise.all(i.map((t=>modifyCustomAliasImports(t,e))))}))}function modifyLayoutFile(t){return __awaiter(this,void 0,void 0,(function*(){if(!fs.existsSync(t))return;const e=(new Project).addSourceFileAtPath(t);e.getImportDeclarations().some((t=>"./_trpc/TrpcProvider"===t.getModuleSpecifierValue()))||e.addImportDeclaration({moduleSpecifier:"./_trpc/TrpcProvider",defaultImport:"TrpcProvider"});const r=e.getDefaultExportSymbol(),i=null==r?void 0:r.getDeclarations()[0];if(i&&"default"===(null==r?void 0:r.getName())){const t=i.getFirstDescendantByKind(SyntaxKind.ReturnStatement),e=null==t?void 0:t.getFirstDescendantByKind(SyntaxKind.JsxElement);if(e){if(!e.getDescendantsOfKind(SyntaxKind.JsxElement).find((t=>"TrpcProvider"===t.getOpeningElement().getTagNameNode().getText()&&t.getJsxChildren().some((t=>t.getKind()===SyntaxKind.JsxExpression&&t.getText().includes("{children}")))))){const t=e.getDescendantsOfKind(SyntaxKind.JsxExpression).find((t=>t.getText().includes("{children}")));if(t){const e=`<TrpcProvider>${t.getText()}</TrpcProvider>`;t.replaceWithText(e)}}}}yield e.save()}))}function createDirectoryStructure(t,e){return __awaiter(this,void 0,void 0,(function*(){const r=e.src?"src":"";[`./${r}/app/_trpc`,`./${r}/app/api/trpc/[trpc]`,e.src?`./${r}/server/routers`:"./app/server/routers"].forEach((e=>fs.mkdirSync(path.join(t,e),{recursive:!0})));if([{src:"/codes/src/app/_trpc/client.ts",dest:`/${r}/app/_trpc/client.ts`},{src:"/codes/src/app/_trpc/TrpcProvider.tsx",dest:`/${r}/app/_trpc/TrpcProvider.tsx`},{src:"/codes/src/app/_trpc/serverClient.ts",dest:`/${r}/app/_trpc/serverClient.ts`},{src:"/codes/src/app/api/trpc/[trpc]/route.ts",dest:`/${r}/app/api/trpc/[trpc]/route.ts`},{src:"/codes/src/server/index.ts",dest:e.src?`/${r}/server/index.ts`:"/app/server/index.ts"},{src:"/codes/src/server/trpc.ts",dest:e.src?`/${r}/server/trpc.ts`:"/app/server/trpc.ts"}].forEach((({src:e,dest:r})=>{const i=path.join(__dirname,e),s=path.join(t,r),o=fs.readFileSync(i,"utf8");fs.writeFileSync(s,o)})),e.defaultImportAlias&&e.src||(yield updateImportAliasFiles(t,e,r)),!fs.existsSync(path.join(t,`/${r}/app/layout.tsx`))){const e=fs.readFileSync(path.join(__dirname,"/codes/src/app/layout.tsx"),"utf8");return void fs.writeFileSync(path.join(t,`/${r}/app/layout.tsx`),e)}modifyLayoutFile(path.join(t,`/${r}/app/layout.tsx`))}))}function getAnswer(){return __awaiter(this,void 0,void 0,(function*(){const t=[{type:"toggle",name:"src",message:`Are you using ${chalk.blue("`src/` directory")}?`,initial:!0,active:"Yes",inactive:"No"},{type:"toggle",name:"appRouter",message:`Are you using ${chalk.blue("App Router")} (recommended)?`,initial:!0,active:"Yes",inactive:"No",validate:t=>!!t||chalk.red("App Router is required for this installation.")}],e=()=>!1;try{const r=yield prompts(t,{onCancel:e});if(0===Object.keys(r).length)return null;if(!r.appRouter)return null;const i={type:"toggle",name:"importAlias",message:`Are you using default ${chalk.blue("import alias")} (@/*)?`,initial:!0,active:"Yes",inactive:"No"};if((yield prompts(i,{onCancel:e})).importAlias)r.importAlias="@/*";else{const t={type:"text",name:"customImportAlias",message:`Enter your custom ${chalk.blue("import alias")}:`,initial:"@/*",validate:t=>!!/^[A-Za-z0-9_\-@~.#$&]+\/\*$/i.test(t)||chalk.red("Import alias must follow the pattern <prefix>/*")},i=yield prompts(t,{onCancel:e});r.importAlias=i.customImportAlias||"src/*"}return{src:r.src,defaultImportAlias:"@/*"===r.importAlias,importAlias:r.importAlias.replace("/*","")}}catch(t){return null}}))}function installDependencies(t,e){return __awaiter(this,void 0,void 0,(function*(){e.forEach((t=>{})),execSync(`npm install ${e.join(" ")}`,{stdio:"inherit",cwd:t})}))}function main(){return __awaiter(this,void 0,void 0,(function*(){try{const t=yield getAnswer();if(null===t)return;const e=process.cwd(),r=["@trpc/client","@trpc/server","@trpc/react-query","@tanstack/react-query","decimal.js","superjson"];yield installDependencies(e,r),yield createDirectoryStructure(e,t)}catch(t){process.exit(1)}}))}main();